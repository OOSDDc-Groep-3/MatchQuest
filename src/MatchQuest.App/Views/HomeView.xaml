<?xml version="1.0" encoding="utf-8" ?>

<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:MatchQuest.App.ViewModels"
             xmlns:converters="clr-namespace:MatchQuest.App.Converters"
             xmlns:models="clr-namespace:MatchQuest.Core.Models;assembly=MatchQuest.Core"
             x:Class="MatchQuest.App.Views.HomeView"
             x:DataType="vm:HomeViewModel"
             x:Name="HomePage"
             BackgroundImageSource="background.png"
             BackgroundColor="Transparent">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Add the converter -->
            <converters:ProfilePictureConverter x:Key="ProfilePictureConverter" />
            <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
            
            <!-- Colors (matching ChatView) -->
            <Color x:Key="AccentColor">#C0ffee</Color>
            <Color x:Key="OverlayColor">#E91E1E1E</Color>
            <Color x:Key="SecondaryText">#DADADA</Color>
            <Color x:Key="TimestampColor">#B0B0B0</Color>
            <Color x:Key="CardStroke">#A4D5C7</Color>

            <!-- Sizes (matching ChatView) -->
            <x:Double x:Key="AvatarSize">80</x:Double>
            <x:Double x:Key="AvatarRadius">40</x:Double>

            <!-- Styles (matching ChatView) -->
            <Style x:Key="SeparatorStyle" TargetType="BoxView">
                <Setter Property="HeightRequest" Value="1" />
                <Setter Property="BackgroundColor" Value="{StaticResource AccentColor}" />
                <Setter Property="HorizontalOptions" Value="Fill" />
                <Setter Property="Margin" Value="0,0,6,0" />
            </Style>

            <Style x:Key="ContactBorderStyle" TargetType="Border">
                <Setter Property="Margin" Value="0,6,0,0" />
                <Setter Property="Padding" Value="8" />
                <Setter Property="BackgroundColor" Value="Transparent" />
                <Setter Property="StrokeThickness" Value="0" />
            </Style>

            <!-- Make label colors explicit to guarantee contrast over the background image -->
            <Style x:Key="NameLabelStyle" TargetType="Label">
                <Setter Property="FontSize" Value="16" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="#FFFFFFFF" />
                <Setter Property="BackgroundColor" Value="Transparent" />
                <Setter Property="Opacity" Value="1" />
            </Style>

            <Style x:Key="PreviewLabelStyle" TargetType="Label">
                <Setter Property="FontSize" Value="13" />
                <Setter Property="TextColor" Value="#FFDADADA" />
                <Setter Property="LineBreakMode" Value="TailTruncation" />
                <Setter Property="MaxLines" Value="1" />
                <Setter Property="BackgroundColor" Value="Transparent" />
                <Setter Property="Opacity" Value="1" />
            </Style>

            <Style x:Key="TimestampLabelStyle" TargetType="Label">
                <Setter Property="FontSize" Value="11" />
                <Setter Property="TextColor" Value="#FFB0B0B0" />
                <Setter Property="HorizontalOptions" Value="End" />
                <Setter Property="BackgroundColor" Value="Transparent" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="*" ColumnDefinitions="0.38*,0.62*">

        <!-- Full-page semi-opaque overlay (matching ChatView) -->
        <BoxView Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2"
                 Color="{StaticResource OverlayColor}"
                 Opacity="0.8"
                 HorizontalOptions="Fill"
                 VerticalOptions="Fill"
                 InputTransparent="True"/>

        <!-- Left: Matches list (sidebar) - matching ChatView structure -->
        <Border Grid.Row="0" Grid.Column="0"
                Margin="0"
                BackgroundColor="Transparent"
                Stroke="{StaticResource AccentColor}"
                StrokeThickness="0.5">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="0" />
            </Border.StrokeShape>

            <Grid Padding="0" RowDefinitions="Auto,*,Auto">
                <!-- Logo (matching ChatView positioning) -->
                <Image Margin="0,20,450,0" Source="matchquest.png" WidthRequest="150" HeightRequest="141" />
                
                <!-- Header (matching ChatView) -->
                <HorizontalStackLayout Grid.Row="0" Margin="0,34,12,6" Spacing="-30" VerticalOptions="Center" HorizontalOptions="Center">
                    <Label Text="MATCHES"
                           FontSize="32"
                           FontAttributes="Bold"
                           TextColor="{StaticResource AccentColor}"
                           VerticalOptions="Center" />
                </HorizontalStackLayout>

                <!-- Matches collection (matching ChatView padding) -->
                <Grid Grid.Row="1" Padding="30,8,30,0">
                    <VerticalStackLayout Spacing="35">
                        <BoxView Style="{StaticResource SeparatorStyle}" />

                        <CollectionView x:Name="MatchesCollection"
                                        ItemsSource="{Binding Matches}"
                                        SelectionMode="Single"
                                        ItemsLayout="VerticalList"
                                        Margin="0,8,0,0"
                                        SelectionChanged="Matches_SelectionChanged"
                                        BackgroundColor="Transparent"
                                        ItemsUpdatingScrollMode="KeepScrollOffset">
                        
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:User">
                                    <!-- Match card styling (matching ChatView) -->
                                    <Border Margin="0" Padding="24,24,24,24" BackgroundColor="#49192126" StrokeThickness="1" Stroke="#C0ffee">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer
                                                Command="{Binding BindingContext.OpenChatForCommand, Source={x:Reference HomePage}}"
                                                CommandParameter="{Binding .}"
                                                NumberOfTapsRequired="1" />
                                        </Border.GestureRecognizers>

                                        <HorizontalStackLayout Spacing="8" VerticalOptions="Center">
                                            <Image Source="{Binding ProfilePicture, Converter={StaticResource ProfilePictureConverter}}"
                                                   WidthRequest="{StaticResource AvatarSize}"
                                                   HeightRequest="{StaticResource AvatarSize}"
                                                   Aspect="AspectFill"
                                                   HorizontalOptions="Start"
                                                   VerticalOptions="Center">
                                            </Image>

                                           <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Start" Spacing="4">
                                                <Label Text="{Binding Name, FallbackValue='Unknown'}" 
                                                       Style="{StaticResource NameLabelStyle}" 
                                                       FontSize="15"
                                                       Margin="20,10,0,0"
                                                       HorizontalOptions="Start"/>
                                                <Label Text="{Binding LastMessagePreview, FallbackValue='No messages'}"
                                                       Style="{StaticResource PreviewLabelStyle}"
                                                       TextColor="{StaticResource SecondaryText}"
                                                       FontAttributes="Italic"
                                                       FontSize="14"
                                                       LineBreakMode="TailTruncation"
                                                       MaximumWidthRequest="400"
                                                       Margin="20,10,0,0"
                                                       MaxLines="1"
                                                       HorizontalOptions="Start"/>
                                            </VerticalStackLayout> 

                                        </HorizontalStackLayout>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>

                            <CollectionView.EmptyView>
                                <VerticalStackLayout Padding="12" Spacing="6" HorizontalOptions="Center" VerticalOptions="Center">
                                    <Label Text="No matches yet."
                                           FontSize="18"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource SecondaryText}"
                                           HorizontalOptions="Center"
                                           HorizontalTextAlignment="Center"
                                           LineBreakMode="WordWrap" />
                                </VerticalStackLayout>
                            </CollectionView.EmptyView>
                        </CollectionView>
                    </VerticalStackLayout>
                </Grid>

                <!-- Filter picker (matching ChatView positioning) -->
                <Picker Grid.Row="2" x:Name="MyMatchesFilter" 
                        TextColor="{StaticResource AccentColor}" 
                        FontAttributes="Bold" 
                        SelectedIndex="0" 
                        BackgroundColor="#192126" 
                        WidthRequest="220" 
                        Margin="31">
                    <Picker.Items>
                        <x:String>Filter</x:String>
                        <x:String>New</x:String>
                        <x:String>Favorites</x:String>
                    </Picker.Items>
                </Picker>

            </Grid>
        </Border>

        <!-- Right column: Profile Card -->
        <Border Grid.Column="1"
                Margin="0"
                Stroke="{StaticResource AccentColor}"
                StrokeThickness="0.5"
                BackgroundColor="Transparent">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="0" />
            </Border.StrokeShape>

            <Grid>
                <!-- Top controls (matching ChatView positioning) -->
                <HorizontalStackLayout Spacing="18" HorizontalOptions="End" Padding="20" VerticalOptions="Start">
                    <Picker x:Name="NewMatchesFilter" 
                            TextColor="{StaticResource AccentColor}" 
                            FontAttributes="Bold" 
                            SelectedIndex="0" 
                            BackgroundColor="#192126" 
                            WidthRequest="140">
                        <Picker.Items>
                            <x:String>FILTER</x:String>
                        </Picker.Items>
                    </Picker>

                    <ImageButton x:Name="SettingsButton"
                                 Source="settings.png"
                                 CornerRadius="28"
                                 WidthRequest="32"
                                 HeightRequest="32"
                                 HorizontalOptions="End"
                                 VerticalOptions="Start"
                                 Command="{Binding OpenSettingsCommand}"/>
                </HorizontalStackLayout>

                <Grid>
                    <!-- No people left message -->
                    <VerticalStackLayout 
                        IsVisible="{Binding HasMatch, Converter={StaticResource InverseBoolConverter}}"
                        VerticalOptions="Center" 
                        HorizontalOptions="Center"
                        Spacing="12">
        
                        <Label Text="No more people to match with"
                               TextColor="{StaticResource AccentColor}"
                               FontSize="24"
                               FontAttributes="Bold"
                               HorizontalOptions="Center" />

                        <Label Text="Check back later for new matches!"
                               TextColor="{StaticResource SecondaryText}"
                               FontSize="16"
                               HorizontalOptions="Center" />
                    </VerticalStackLayout>
                    
                    <Border Margin="120"
                            IsVisible="{Binding HasMatch}"
                            Stroke="{StaticResource CardStroke}"
                            StrokeThickness="2"
                            BackgroundColor="Transparent">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="28" />
                        </Border.StrokeShape>

                    <ScrollView Orientation="Vertical" VerticalOptions="Fill" HorizontalOptions="Fill">
                        <VerticalStackLayout Spacing="8" Padding="12" BackgroundColor="Transparent">
                            <!-- Profile Picture -->
                            <Image Source="{Binding CurrentProfileImage}"
                                   HeightRequest="250"
                                   WidthRequest="250"
                                   Aspect="AspectFill"
                                   HorizontalOptions="Center">
                                <Image.Clip>
                                    <EllipseGeometry Center="125,125" RadiusX="125" RadiusY="125" />
                                </Image.Clip>
                            </Image>
                            <HorizontalStackLayout Spacing="250">
                                <HorizontalStackLayout Spacing="12">
                                    <Label Text="{Binding CurrentMatch.Matcher.Name}" FontSize="22" FontAttributes="Bold" TextColor="{StaticResource AccentColor}" HorizontalOptions="Start" />
                                    <Label Text="{Binding CurrentMatchAge}" FontSize="22" FontAttributes="Bold" TextColor="{StaticResource AccentColor}" HorizontalOptions="Start" />
                                </HorizontalStackLayout> 
                            <Label Text="{Binding CurrentMatch.Matcher.Region}" FontSize="16" FontAttributes="Bold" TextColor="{StaticResource SecondaryText}" HorizontalOptions="Start" Margin="0,3" />
                                </HorizontalStackLayout>
                            <Label Text="Catan, Chess" FontSize="15" FontAttributes="Bold" TextColor="{StaticResource AccentColor}" Margin="0,3" HorizontalOptions="Start" />
                            <BoxView Style="{StaticResource SeparatorStyle}" />

                            <Border BackgroundColor="#192126" Padding="12" HorizontalOptions="Fill">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="10" />
                                </Border.StrokeShape>
                                <Label Text="{Binding CurrentMatch.Matcher.Biography}"
                                       FontSize="14" TextColor="White" HorizontalOptions="Center" BackgroundColor="Transparent" />
                            </Border>
                            <BoxView Style="{StaticResource SeparatorStyle}" />
                            
                            <!-- Games Collection -->
                            <CollectionView ItemsSource="{Binding Games}"
                                            SelectionMode="None"
                                            ItemsLayout="VerticalList"
                                            HeightRequest="120"
                                            HorizontalOptions="Fill">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Border BackgroundColor="{StaticResource OverlayColor}" Padding="6" Margin="6" StrokeThickness="0">
                                            <VerticalStackLayout Spacing="6" HorizontalOptions="Center" VerticalOptions="Center" WidthRequest="84">
                                                <Image Source="{Binding Image}"
                                                       WidthRequest="72"
                                                       HeightRequest="72"
                                                       Aspect="AspectFill">
                                                    <Image.Clip>
                                                        <EllipseGeometry Center="36,36" RadiusX="36" RadiusY="36" />
                                                    </Image.Clip>
                                                </Image>
                                                <Label Text="{Binding Name}"
                                                       FontSize="12"
                                                       LineBreakMode="TailTruncation"
                                                       MaxLines="1"
                                                       HorizontalOptions="Center"
                                                       TextColor="{StaticResource AccentColor}" />
                                            </VerticalStackLayout>
                                        </Border>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>

                                <CollectionView.EmptyView>
                                    <VerticalStackLayout Padding="12" Spacing="6" HorizontalOptions="Center" VerticalOptions="Center">
                                        <Label Text="No games have been added yet!"
                                               FontSize="18"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource SecondaryText}"
                                               HorizontalOptions="Center"
                                               HorizontalTextAlignment="Center"
                                               LineBreakMode="WordWrap" />
                                    </VerticalStackLayout>
                                </CollectionView.EmptyView>
                            </CollectionView>

                        </VerticalStackLayout>
                       </ScrollView>
                    </Border>
                    </Grid>

                <HorizontalStackLayout 
                    IsVisible="{Binding HasMatch}"
                    Grid.Column="0" 
                    Spacing="150"
                    HorizontalOptions="Center" 
                    VerticalOptions="End"
                    TranslationY="-90"
                    BackgroundColor="Transparent">
                    <ImageButton Source="dislike.png" BackgroundColor="Transparent" WidthRequest="80" HeightRequest="80" Command="{Binding DislikeCommand}" />
                    <ImageButton Source="like.png" BackgroundColor="Transparent" WidthRequest="80" HeightRequest="80" Command="{Binding LikeCommand}" />
                </HorizontalStackLayout>
            </Grid>
        </Border>

        <Border Grid.Row="0"
                Grid.Column="0"
                Grid.ColumnSpan="2"
                IsVisible="{Binding IsToastVisible}"
                BackgroundColor="{Binding ToastBackgroundColor}"
                Stroke="Transparent"
                VerticalOptions="Start"
                HorizontalOptions="Center"
                Margin="0,20,0,0"
                Padding="20,10">
            
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="20" />
            </Border.StrokeShape>
            
            <Border.Shadow>
                <Shadow Brush="Black" Offset="0,4" Radius="10" Opacity="0.5" />
            </Border.Shadow>

            <Label Text="{Binding ToastMessage}"
                   TextColor="White"
                   FontAttributes="Bold"
                   FontSize="14"
                   HorizontalOptions="Center"
                   VerticalOptions="Center" />
        </Border>
        
    </Grid>
</ContentPage>