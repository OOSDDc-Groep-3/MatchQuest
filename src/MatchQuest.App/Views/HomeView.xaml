<?xml version="1.0" encoding="utf-8" ?>

<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:MatchQuest.App.ViewModels"
             xmlns:models="clr-namespace:MatchQuest.Core.Models;assembly=MatchQuest.Core"
             xmlns:converters="clr-namespace:MatchQuest.App.Converters"
             x:Class="MatchQuest.App.Views.HomeView"
             x:DataType="vm:HomeViewModel"
             x:Name="HomePage"
             BackgroundImageSource="background.png"
             BackgroundColor="Transparent">

    <ContentPage.Resources>
        <ResourceDictionary>
            
            <!-- Converter for Base64 to image -->
            <converters:ProfilePictureConverter x:Key="ProfilePictureConverter" />
            
            <!-- Colors -->
            <Color x:Key="AccentColor">#C0ffee</Color>
            <Color x:Key="OverlayColor">#E91E1E1E</Color>
            <Color x:Key="SecondaryText">#DADADA</Color>
            <Color x:Key="TimestampColor">#B0B0B0</Color>
            <Color x:Key="CardStroke">#A4D5C7</Color>

            <!-- Sizes -->
            <x:Double x:Key="AvatarSize">48</x:Double>
            <x:Double x:Key="AvatarRadius">24</x:Double>

            <!-- Styles -->
            <Style x:Key="SeparatorStyle" TargetType="BoxView">
                <Setter Property="HeightRequest" Value="1" />
                <Setter Property="BackgroundColor" Value="{StaticResource AccentColor}" />
                <Setter Property="HorizontalOptions" Value="Fill" />
                <Setter Property="Margin" Value="0,6,6,0" />
            </Style>

            <Style x:Key="ContactBorderStyle" TargetType="Border">
                <Setter Property="Margin" Value="0,6,0,0" />
                <Setter Property="Padding" Value="8" />
                <Setter Property="BackgroundColor" Value="Transparent" />
                <Setter Property="StrokeThickness" Value="0" />
            </Style>

            <!-- Make label colors explicit to guarantee contrast over the background image -->
            <Style x:Key="NameLabelStyle" TargetType="Label">
                <Setter Property="FontSize" Value="16" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="#FFFFFFFF" />
                <Setter Property="BackgroundColor" Value="Transparent" />
                <Setter Property="Opacity" Value="1" />
            </Style>

            <Style x:Key="PreviewLabelStyle" TargetType="Label">
                <Setter Property="FontSize" Value="13" />
                <Setter Property="TextColor" Value="#FFDADADA" />
                <Setter Property="LineBreakMode" Value="TailTruncation" />
                <Setter Property="MaxLines" Value="1" />
                <Setter Property="BackgroundColor" Value="Transparent" />
                <Setter Property="Opacity" Value="1" />
            </Style>

            <Style x:Key="TimestampLabelStyle" TargetType="Label">
                <Setter Property="FontSize" Value="11" />
                <Setter Property="TextColor" Value="#FFB0B0B0" />
                <Setter Property="HorizontalOptions" Value="End" />
                <Setter Property="BackgroundColor" Value="Transparent" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="*" ColumnDefinitions="0.4*,0.8*">

        <!-- Semi-opaque dark overlay -->
        <BoxView Grid.Column="0"
                 Grid.ColumnSpan="2"
                 Color="{StaticResource OverlayColor}"
                 HorizontalOptions="Fill"
                 VerticalOptions="Fill"
                 InputTransparent="True" />

        <!-- Left: Matches list (sidebar) -->
        <Border Grid.Column="0"
                Margin="0"
                BackgroundColor="Transparent"
                Stroke="{StaticResource AccentColor}"
                StrokeThickness="2">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="0" />
            </Border.StrokeShape>

            <Grid Padding="0" RowDefinitions="Auto,*,Auto">

                <Image Margin="0,10,390,0" Source="matchquest.png" WidthRequest="150" HeightRequest="141" />
                <!-- Header -->
                <HorizontalStackLayout Grid.Row="0" Margin="0,24,32,6" Spacing="-30" VerticalOptions="Center" HorizontalOptions="Center">
                    <Label Text="MATCHES"
                           FontSize="32"
                           FontAttributes="Bold"
                           TextColor="{StaticResource AccentColor}"
                           VerticalOptions="Center" />
                </HorizontalStackLayout>

                <!-- NOTE: CollectionView must not be nested inside a ScrollView.
                     A nested ScrollView can prevent CollectionView from laying out / rendering items.
                     Use CollectionView's built-in scrolling instead. -->
                <Grid Grid.Row="1" Padding="8">
                    <VerticalStackLayout Spacing="8">
                        <BoxView Style="{StaticResource SeparatorStyle}" />
                        

                        <!-- Matches collection -->
                        <CollectionView x:Name="MatchesCollection"
                                        ItemsSource="{Binding Matches}"
                                        SelectionMode="Single"
                                        ItemsLayout="VerticalList"
                                        Margin="0,8,0,0"
                                        SelectionChanged="Matches_SelectionChanged"
                                        BackgroundColor="Transparent"
                                        ItemsUpdatingScrollMode="KeepScrollOffset">
                            
                            <CollectionView.ItemTemplate>
                                <!-- Added x:DataType and TapGesture to use strongly-typed bindings and call the VM command -->
                                <DataTemplate x:DataType="models:User">
                                    <!-- Visible card (high contrast) so labels are readable over background image -->
                                    <Border Margin="4" Padding="24" BackgroundColor="Transparent" StrokeThickness="1" Stroke="#C0ffee">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer
                                                Command="{Binding BindingContext.OpenChatForCommand, Source={x:Reference HomePage}}"
                                                CommandParameter="{Binding .}"
                                                NumberOfTapsRequired="1" />
                                        </Border.GestureRecognizers>

                                        <HorizontalStackLayout Spacing="8" VerticalOptions="Center">
                                            <Image Source="{Binding ProfilePicture, Converter={StaticResource ProfilePictureConverter}, FallbackValue='showcaseprofile.png'}"
                                                   WidthRequest="{StaticResource AvatarSize}"
                                                   HeightRequest="{StaticResource AvatarSize}"
                                                   Aspect="AspectFill"
                                                   HorizontalOptions="Start"
                                                   VerticalOptions="Center">
                                                <Image.Clip>
                                                    <EllipseGeometry Center="24,24" RadiusX="24" RadiusY="24" />
                                                </Image.Clip>
                                            </Image>

                                           <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Start" Spacing="4">
                                                <!-- Use strongly-typed binding to Name -->
                                                <Label Text="{Binding Name, FallbackValue='Unknown'}" Style="{StaticResource NameLabelStyle}" TextColor="#C0ffee" />
                                                <!-- Last-message preview shown under the name -->
                                                <Label Text="{Binding LastMessagePreview, FallbackValue=''}"
                                                       Style="{StaticResource PreviewLabelStyle}"
                                                       TextColor="{StaticResource SecondaryText}"
                                                       LineBreakMode="TailTruncation"
                                                       MaxLines="1" />
                                            </VerticalStackLayout> 

                                        </HorizontalStackLayout>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>

                            <CollectionView.EmptyView>
                                <VerticalStackLayout Padding="12" Spacing="6" HorizontalOptions="Center" VerticalOptions="Center">
                                    <Label Text="No matches yet."
                                           FontSize="18"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource SecondaryText}"
                                           HorizontalOptions="Center"
                                           HorizontalTextAlignment="Center"
                                           LineBreakMode="WordWrap" />
                                </VerticalStackLayout>
                            </CollectionView.EmptyView>
                        </CollectionView>
                    </VerticalStackLayout>
                </Grid>

                <!-- Picker remains in the bottom row so it is always visible -->
                <Picker Grid.Row="2" x:Name="MyMatchesFilter" TextColor="{StaticResource AccentColor}" FontAttributes="Bold" SelectedIndex="0" BackgroundColor="#192126" WidthRequest="220" Margin="31">
                    <Picker.Items>
                        <x:String>My Matches Filter</x:String>
                        <x:String>New</x:String>
                        <x:String>Favorites</x:String>
                        <x:String>Nearby</x:String>
                        <x:String>Action</x:String>
                        <x:String>Adventure</x:String>
                        <x:String>Action-adventure</x:String>
                        <x:String>Role-playing (RPG)</x:String>
                        <x:String>Shooter (FPS / TPS)</x:String>
                        <x:String>Fighting</x:String>
                        <x:String>Platformer</x:String>
                        <x:String>Strategy (RTS, turn-based, 4X)</x:String>
                        <x:String>Simulation</x:String>
                        <x:String>Sports</x:String>
                        <x:String>Racing</x:String>
                        <x:String>Puzzle</x:String>
                        <x:String>Stealth</x:String>
                        <x:String>Survival</x:String>
                        <x:String>Horror</x:String>
                        <x:String>Sandbox / Open-world</x:String>
                        <x:String>Massively Multiplayer Online (MMO / MMORPG)</x:String>
                        <x:String>Battle Royale</x:String>
                        <x:String>Party / Casual</x:String>
                    </Picker.Items>
                </Picker>

            </Grid>
        </Border>

        <!-- Right column: Profile Card (unchanged structure, tightened spacing where helpful) -->
        <Border Grid.Column="1"
                Margin="0"
                Stroke="{StaticResource AccentColor}"
                StrokeThickness="2"
                BackgroundColor="Transparent">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="0" />
            </Border.StrokeShape>

            <Grid>
                <HorizontalStackLayout Spacing="18" HorizontalOptions="End" Padding="20" VerticalOptions="Start">
                    <Picker x:Name="NewMatchesFilter" TextColor="{StaticResource AccentColor}" FontAttributes="Bold" SelectedIndex="0" BackgroundColor="#192126" WidthRequest="220">
                        <Picker.Items>
                            <x:String>Suggested Matches Filter</x:String>
                            <x:String>New</x:String>
                            <x:String>Favorites</x:String>
                            <x:String>Nearby</x:String>
                            <x:String>Action</x:String>
                            <x:String>Adventure</x:String>
                            <x:String>Action-adventure</x:String>
                            <x:String>Role-playing (RPG)</x:String>
                            <x:String>Shooter (FPS / TPS)</x:String>
                            <x:String>Fighting</x:String>
                            <x:String>Platformer</x:String>
                            <x:String>Strategy (RTS, turn-based, 4X)</x:String>
                            <x:String>Simulation</x:String>
                            <x:String>Sports</x:String>
                            <x:String>Racing</x:String>
                            <x:String>Puzzle</x:String>
                            <x:String>Stealth</x:String>
                            <x:String>Survival</x:String>
                            <x:String>Horror</x:String>
                            <x:String>Sandbox / Open-world</x:String>
                            <x:String>Massively Multiplayer Online (MMO / MMORPG)</x:String>
                            <x:String>Battle Royale</x:String>
                            <x:String>Party / Casual</x:String>
                        </Picker.Items>
                    </Picker>

                    <ImageButton x:Name="SettingsButton"
                                 Source="settings.png"
                                 BackgroundColor="{StaticResource AccentColor}"
                                 CornerRadius="28"
                                 WidthRequest="32"
                                 HeightRequest="32"
                                 HorizontalOptions="End"
                                 VerticalOptions="Start"
                                 Command="{Binding OpenSettingsCommand}"
                                 />
                </HorizontalStackLayout>

                <Border Margin="120"
                        Stroke="{StaticResource CardStroke}"
                        StrokeThickness="2"
                        BackgroundColor="Transparent">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="28" />
                    </Border.StrokeShape>

                    <ScrollView Orientation="Vertical" VerticalOptions="Fill" HorizontalOptions="Fill">
                        <VerticalStackLayout Spacing="8" Padding="12" BackgroundColor="Transparent">
                            <Image Source="showcaseprofile.png" HeightRequest="250" WidthRequest="250" Margin="0,0,0,8" HorizontalOptions="Center" Aspect="AspectFill">
                                <Image.Clip>
                                    <EllipseGeometry Center="125,125" RadiusX="125" RadiusY="125" />
                                </Image.Clip>
                            </Image>
                            <HorizontalStackLayout Spacing="250"> 
                                <Label Text="Britney, 27" FontSize="22" FontAttributes="Bold" TextColor="{StaticResource AccentColor}" HorizontalOptions="Start" />
                            <Label Text="Zwolle" FontSize="16" FontAttributes="Bold" TextColor="{StaticResource SecondaryText}" HorizontalOptions="Start" Margin="0,3" />
                                </HorizontalStackLayout>
                            <Label Text="Catan, Chess" FontSize="15" FontAttributes="Bold" TextColor="{StaticResource AccentColor}" Margin="0,3" HorizontalOptions="Start" />
                            <BoxView Style="{StaticResource SeparatorStyle}" />

                            <Border BackgroundColor="#192126" Padding="12" HorizontalOptions="Fill">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="10" />
                                </Border.StrokeShape>
                                <Label Text="Lorem ipsum dolor sit amet, consectetur adipiscing elit. Quisque ut urna volutpat, elementum metus id, bibendum lacus. Cras sodales elit arcu, ut sodales ipsum molestie sit amet. Curabitur commodo non eros in pretium. Fusce ornare purus sodales metus venenatis, at pulvinar erat porta. Vestibulum rhoncus ante sed placerat viverra. Donec finibus tortor eu velit eleifend tincidunt. Suspendisse et mi a neque euismod blandit vitae id justo. Suspendisse fermentum fringilla augue, auctor vulputate arcu pharetra vehicula. Sed porta massa nec finibus viverra. Sed elementum tellus vel lacus vestibulum, eget venenatis enim aliquam."
                                       FontSize="14" TextColor="White" HorizontalOptions="Center" BackgroundColor="Transparent" />
                            </Border>
                            <BoxView Style="{StaticResource SeparatorStyle}" />
                            
                            <!-- Games Collection: shows game image and name; displays placeholder text when empty -->
                            <CollectionView ItemsSource="{Binding Games}"
                                            SelectionMode="None"
                                            ItemsLayout="VerticalList"
                                            HeightRequest="120"
                                            HorizontalOptions="Fill">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Border BackgroundColor="{StaticResource OverlayColor}" Padding="6" Margin="6" StrokeThickness="0">
                                            <VerticalStackLayout Spacing="6" HorizontalOptions="Center" VerticalOptions="Center" WidthRequest="84">
                                                <Image Source="{Binding Image}"
                                                       WidthRequest="72"
                                                       HeightRequest="72"
                                                       Aspect="AspectFill">
                                                    <Image.Clip>
                                                        <EllipseGeometry Center="36,36" RadiusX="36" RadiusY="36" />
                                                    </Image.Clip>
                                                </Image>
                                                <Label Text="{Binding Name}"
                                                       FontSize="12"
                                                       LineBreakMode="TailTruncation"
                                                       MaxLines="1"
                                                       HorizontalOptions="Center"
                                                       TextColor="{StaticResource AccentColor}" />
                                            </VerticalStackLayout>
                                        </Border>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>

                                <CollectionView.EmptyView>
                                    <VerticalStackLayout Padding="12" Spacing="6" HorizontalOptions="Center" VerticalOptions="Center">
                                        <Label Text="No games have been added yet!"
                                               FontSize="18"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource SecondaryText}"
                                               HorizontalOptions="Center"
                                               HorizontalTextAlignment="Center"
                                               LineBreakMode="WordWrap" />
                                    </VerticalStackLayout>
                                </CollectionView.EmptyView>
                            </CollectionView>

                        </VerticalStackLayout>
                    </ScrollView>
                </Border>

                <HorizontalStackLayout Grid.Column="0" Spacing="150" HorizontalOptions="Center" VerticalOptions="End" TranslationY="-90" BackgroundColor="Transparent" InputTransparent="True">
                    <ImageButton Source="dislike.png" BackgroundColor="Transparent" WidthRequest="80" HeightRequest="80" />
                    <ImageButton Source="like.png" BackgroundColor="Transparent" WidthRequest="80" HeightRequest="80" />
                </HorizontalStackLayout>
            </Grid>
        </Border>

    </Grid>
</ContentPage>