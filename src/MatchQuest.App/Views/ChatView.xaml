<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:MatchQuest.App.ViewModels"
             xmlns:models="clr-namespace:MatchQuest.Core.Models;assembly=MatchQuest.Core"
             xmlns:converters="clr-namespace:MatchQuest.App.Converters"
             xmlns:shapes="clr-namespace:Microsoft.Maui.Controls.Shapes;assembly=Microsoft.Maui.Controls"
             x:Class="MatchQuest.App.Views.ChatView"
             x:DataType="vm:ChatViewModel"
             x:Name="ChatPage"
             BackgroundImageSource="background.png"
             BackgroundColor="Transparent">

    <ContentPage.Resources>
        <ResourceDictionary>
            
            <!-- Converter for Base64 to image -->
            <converters:ProfilePictureConverter x:Key="ProfilePictureConverter" />
            
            <!-- Colors -->
            <Color x:Key="AccentColor">#C0ffee</Color>
            <Color x:Key="OverlayColor">#E91E1E1E</Color>
            <Color x:Key="SecondaryText">#DADADA</Color>
            <Color x:Key="TimestampColor">#B0B0B0</Color>
            <Color x:Key="CardStroke">#A4D5C7</Color>
            <Color x:Key="BubbleInboundBg">#001E1E1E</Color>
            <Color x:Key="BubbleOutboundBg">#C0ffee</Color>
            <Color x:Key="BubbleInboundStroke">#A4D5C7</Color>

            <!-- Sizes -->
            <x:Double x:Key="AvatarSize">80</x:Double>
            <x:Double x:Key="AvatarRadius">80</x:Double>

            <!-- Styles -->
            <Style x:Key="SeparatorStyle" TargetType="BoxView">
                <Setter Property="HeightRequest" Value="1" />
                <Setter Property="BackgroundColor" Value="{StaticResource AccentColor}" />
                <Setter Property="HorizontalOptions" Value="Fill" />
                <Setter Property="Margin" Value="0,0,6,0" />
            </Style>

            <Style x:Key="ContactBorderStyle" TargetType="Border">
                <Setter Property="Margin" Value="0,6,0,0" />
                <Setter Property="Padding" Value="8" />
                <Setter Property="BackgroundColor" Value="Transparent" />
                <Setter Property="StrokeThickness" Value="0" />
            </Style>

            <!-- Updated to match HomeView: explicit high-contrast label styling -->
            <Style x:Key="NameLabelStyle" TargetType="Label">
                <Setter Property="FontSize" Value="16" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="#FFFFFFFF" />
                <Setter Property="BackgroundColor" Value="Transparent" />
                <Setter Property="Opacity" Value="1" />
            </Style>

            <Style x:Key="PreviewLabelStyle" TargetType="Label">
                <Setter Property="FontSize" Value="13" />
                <Setter Property="TextColor" Value="#FFDADADA" />
                <Setter Property="LineBreakMode" Value="TailTruncation" />
                <Setter Property="MaxLines" Value="1" />
                <Setter Property="BackgroundColor" Value="Transparent" />
                <Setter Property="Opacity" Value="1" />
            </Style>

            <Style x:Key="TimestampLabelStyle" TargetType="Label">
                <Setter Property="FontSize" Value="11" />
                <Setter Property="TextColor" Value="#FFB0B0B0" />
                <Setter Property="HorizontalOptions" Value="End" />
                <Setter Property="BackgroundColor" Value="Transparent" />
            </Style>

            <!-- Message bubble styles -->
            <Style x:Key="InboundBubble" TargetType="Border">
                <Setter Property="BackgroundColor" Value="{StaticResource BubbleInboundBg}" />
                <Setter Property="Stroke" Value="{StaticResource BubbleInboundStroke}" />
                <Setter Property="StrokeThickness" Value="1.5" />
                <Setter Property="Padding" Value="12" />
            </Style>

            <Style x:Key="OutboundBubble" TargetType="Border">
                <Setter Property="BackgroundColor" Value="{StaticResource BubbleOutboundBg}" />
                <Setter Property="StrokeThickness" Value="1.5" />
                <Setter Property="Padding" Value="12" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*,Auto" ColumnDefinitions="0.38*,0.62*">

        <!-- Full-page semi-opaque overlay so background image reads darker -->
        <BoxView Grid.Row="0" Grid.RowSpan="3" Grid.Column="0" Grid.ColumnSpan="2"
                 Color="{StaticResource OverlayColor}"
                 HorizontalOptions="Fill" VerticalOptions="Fill"
                 InputTransparent="True"
                 Opacity="1"/>

        <!-- Left: Matches list (sidebar) - updated to match HomeView visual structure -->
        <Border Grid.Row="0" Grid.RowSpan="3" Grid.Column="0"
                Margin="0"
                BackgroundColor="Transparent"
                Stroke="{StaticResource AccentColor}"
                StrokeThickness="0.5">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="0" />
            </Border.StrokeShape>

            <!-- Replaced VerticalStackLayout with Grid (same structure as HomeView) -->
            <Grid Padding="0" RowDefinitions="Auto,*,Auto">
                <Image Margin="0,20,450,0" Source="matchquest.png" WidthRequest="150" HeightRequest="141" />

                <!-- Header: larger high-contrast header like HomeView -->
                <HorizontalStackLayout Grid.Row="0" Margin="0,34,12,6" Spacing="-30" VerticalOptions="Center" HorizontalOptions="Center">

                    <Label Text="MATCHES"
                           FontSize="32"
                           FontAttributes="Bold"
                           TextColor="{StaticResource AccentColor}"
                           VerticalOptions="Center" />
                </HorizontalStackLayout>

                <!-- Matches collection (keeps binding to ChatViewModel.Matches and existing command usage) -->
                <Grid Grid.Row="1" Padding="30,8,30,0">
                    <VerticalStackLayout Spacing="35">
                        <BoxView Style="{StaticResource SeparatorStyle}" />

                        <CollectionView x:Name="MatchesCollection"
                                        ItemsSource="{Binding Matches}"
                                        SelectionMode="Single"
                                        ItemsLayout="VerticalList"
                                        Margin="0,8,0,0"
                                        BackgroundColor="Transparent"
                                        ItemsUpdatingScrollMode="KeepScrollOffset">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:User">
                                    <!-- Visible card (high contrast) so labels are readable over background image -->
                                    <Border Margin="0" Padding="24,24,24,24" BackgroundColor="#49192126"  StrokeThickness="1" Stroke="#C0ffee">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer
                                                Command="{Binding BindingContext.OpenMatchCommand, Source={x:Reference ChatPage}}"
                                                CommandParameter="{Binding .}"
                                                NumberOfTapsRequired="1" />
                                        </Border.GestureRecognizers>

                                        <HorizontalStackLayout Spacing="8" VerticalOptions="Center">
                                            <Image Source="{Binding ProfilePicture, Converter={StaticResource ProfilePictureConverter}}"
                                                   WidthRequest="{StaticResource AvatarSize}"
                                                   HeightRequest="{StaticResource AvatarSize}"
                                                   Aspect="AspectFill"
                                                   HorizontalOptions="Start"
                                                   VerticalOptions="Center">
                                            </Image>

                                            <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Start" Spacing="4">
                                                <Label Text="{Binding Name, FallbackValue='Unknown'}" 
                                                       Style="{StaticResource NameLabelStyle}" 
                                                       FontSize="15"
                                                       Margin="20,10,0,0"
                                                       HorizontalOptions="Start"/>
                                                <!-- Last-message preview shown under the name -->
                                                <Label Text="{Binding LastMessagePreview, FallbackValue='No messages'}"
                                                       Style="{StaticResource PreviewLabelStyle}"
                                                       TextColor="{StaticResource SecondaryText}"
                                                       FontAttributes="Italic"
                                                       FontSize="14"
                                                       LineBreakMode="TailTruncation"
                                                       MaximumWidthRequest="400"
                                                       Margin="20,10,0,0"
                                                       MaxLines="1"
                                                       HorizontalOptions="Start"/>
                                            </VerticalStackLayout>

                                        </HorizontalStackLayout>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>

                            <CollectionView.EmptyView>
                                <VerticalStackLayout Padding="12" Spacing="6" HorizontalOptions="Center" VerticalOptions="Center">
                                    <Label Text="No matches yet."
                                           FontSize="18"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource SecondaryText}"
                                           HorizontalOptions="Center"
                                           HorizontalTextAlignment="Center"
                                           LineBreakMode="WordWrap" />
                                </VerticalStackLayout>
                            </CollectionView.EmptyView>
                        </CollectionView>
                    </VerticalStackLayout>
                </Grid>

                <!-- Filter picker at bottom (keeps it visible like HomeView) -->
                <Picker Grid.Row="2" x:Name="MyMatchesFilter" TextColor="{StaticResource AccentColor}" FontAttributes="Bold" SelectedIndex="0" BackgroundColor="#192126" WidthRequest="220" Margin="31">
                    <Picker.Items>
                        <x:String>Filter</x:String>
                        <x:String>New</x:String>
                        <x:String>Favorites</x:String>
                    </Picker.Items>
                </Picker>

            </Grid>
        </Border>

        <!-- Right: Chat area header -->
        <Grid Grid.Column="1" Grid.Row="0" Margin="10,-10,10,0" Padding="32" ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto">
            <ImageButton BackgroundColor="Transparent" Margin="10,5,20,10" Source="back.png" WidthRequest="38" HeightRequest="38" VerticalOptions="Center" Command="{Binding BackCommand}" />
            
            <!-- Replace the Label with this clickable version -->
            <Label Grid.Column="1" 
                   Text="{Binding PartnerName}" 
                   FontSize="32" 
                   FontAttributes="Bold" 
                   TextColor="{StaticResource AccentColor}" 
                   VerticalOptions="Center" 
                   HorizontalOptions="Start">
                <Label.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding ViewPartnerProfileCommand}" />
                </Label.GestureRecognizers>
            </Label>
            
            <HorizontalStackLayout Grid.Column="2" Spacing="8" VerticalOptions="Center" HorizontalOptions="End">
                <Picker x:Name="NewMatchesFilter" TextColor="{StaticResource AccentColor}" FontAttributes="Bold" SelectedIndex="0" BackgroundColor="#192126" WidthRequest="140">
                    <Picker.Items>
                        <x:String>FILTER</x:String>
                    </Picker.Items>
                </Picker>
                <ImageButton Source="settings.png" CornerRadius="28" WidthRequest="32" HeightRequest="32" />
            </HorizontalStackLayout>

            <!-- header divider -->
            <BoxView Grid.Row="1" Grid.ColumnSpan="3" HeightRequest="1" BackgroundColor="{StaticResource AccentColor}" VerticalOptions="End" Margin="0,148,0,0" />
        </Grid>

        <!-- Right: Chat messages card -->
        <Border Grid.Column="1" Grid.Row="1" Margin="32,12,32,12"
                Stroke="#c0ffee"
                StrokeThickness="0.5"
                Padding="20,20,20,20">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="10" />
            </Border.StrokeShape>

            <Grid>
                <!-- CollectionView bound to Messages -->
                <CollectionView x:Name="MessagesCollection"
                                ItemsSource="{Binding Messages}"
                                SelectionMode="None"
                                VerticalOptions="Fill"
                                ItemSizingStrategy="MeasureAllItems"
                                ItemsUpdatingScrollMode="KeepLastItemInView">
                    <!-- Make CollectionView measure all items so scrolling to end is accurate -->
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Vertical" />
                    </CollectionView.ItemsLayout>

                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Message">
                            <Grid Padding="8" ColumnDefinitions="*,Auto">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>
                                <Grid>
                                    <!-- Outbound (right) -->
                                    <Grid ColumnDefinitions="*,Auto" IsVisible="{Binding IsOutbound}">
                                        <StackLayout Orientation="Horizontal" HorizontalOptions="End" Spacing="8">
                                            <Border Margin="0,0,20,10" BackgroundColor="#C0ffee" Padding="12" StrokeThickness="1.5">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="14,14,14,0" />
                                                </Border.StrokeShape>
                                                <!-- Allow wrapping and preserve newlines -->
                                                <Label Text="{Binding MessageText}"
                                                       TextColor="Black"
                                                       LineBreakMode="WordWrap"
                                                       MaximumWidthRequest="600"/>
                                            </Border>
                                            <Image VerticalOptions="End" Source="{Binding ProfilePicture, Converter={StaticResource ProfilePictureConverter}, FallbackValue='showcaseprofile.png'}" WidthRequest="48" HeightRequest="48">
                                                <Image.Clip>
                                                    <EllipseGeometry Center="24,24" RadiusX="24" RadiusY="24" />
                                                </Image.Clip>
                                            </Image>
                                        </StackLayout>
                                    </Grid>
                                    <!-- Inbound (left) -->
                                    <Grid ColumnDefinitions="Auto,*" IsVisible="{Binding IsOutbound, Converter={StaticResource InverseBooleanConverter}}">
                                        <StackLayout Orientation="Horizontal" HorizontalOptions="Start" Spacing="8">
                                            <Image VerticalOptions="End" Source="{Binding ProfilePicture, Converter={StaticResource ProfilePictureConverter}, FallbackValue='showcaseprofile.png'}" WidthRequest="48" HeightRequest="48">
                                                <Image.Clip>
                                                    <EllipseGeometry Center="24,24" RadiusX="24" RadiusY="24" />
                                                </Image.Clip>
                                            </Image>
                                            <Border Margin="20,0,0,10" BackgroundColor="#383535" Stroke="#A4D5C7" StrokeThickness="1.5" Padding="12">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="14,14,0,14" />
                                                </Border.StrokeShape>
                                                <!-- Fixed broken attribute and enable wrapping/newlines -->
                                                <Label Text="{Binding MessageText}"
                                                       TextColor="#DADADA"
                                                       LineBreakMode="WordWrap"
                                                       MaximumWidthRequest="600"/>
                                            </Border>
                                        </StackLayout>
                                    </Grid>
                                </Grid>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </Grid>
        </Border>

        <!-- Input area (binds to viewmodel SendMessage) -->
        <Grid Grid.Column="1" Grid.Row="2" Padding="30,40,40,40" ColumnDefinitions="*,Auto" VerticalOptions="End" ColumnSpacing="20">
            <Border Stroke="#c0ffee">
                <Border.StrokeShape>
                    <RoundRectangle StrokeThickness="10" CornerRadius="12" />
                </Border.StrokeShape>
                <Grid BackgroundColor="#383535">
                    <Entry
                        x:Name="MessageEntry"
                        Text="{Binding MessageText, Mode=TwoWay}"
                        FontAttributes="Italic"
                        FontFamily="RubikRegular"
                        Placeholder="Type a message..."
                        PlaceholderColor="#DADADA"
                        TextColor="#C0ffee"
                        VerticalOptions="Center"
                        ReturnType="Send"
                        BackgroundColor="Transparent"
                        Completed="MessageEntry_Completed"
                        MinimumHeightRequest="60"
                        Margin="20,8,20,8"/>
                </Grid>
            </Border>

            <ImageButton Grid.Column="1" Margin="10,1,16,7" Source="sendicon.png" BackgroundColor="Transparent" WidthRequest="35" HeightRequest="55" CornerRadius="14" Command="{Binding SendMessageCommand}" />
        </Grid>
    </Grid>
</ContentPage>